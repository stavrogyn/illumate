# Observability Stack for Local Development
# Usage: docker compose -f infra/docker/docker-compose.observability.yml up -d
#
# Services:
# - Grafana: http://localhost:3001 (admin/admin)
# - Prometheus: http://localhost:9090
# - VictoriaMetrics: http://localhost:8428
# - Loki: http://localhost:3100
# - Tempo: http://localhost:3200
# - OTEL Collector: http://localhost:4317 (gRPC), http://localhost:4318 (HTTP)

version: '3.8'

services:
  # OpenTelemetry Collector - Central telemetry ingestion
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.95.0
    container_name: psy-otel-collector
    command: ['--config=/etc/otel-collector-config.yaml']
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - '4317:4317' # OTLP gRPC receiver
      - '4318:4318' # OTLP HTTP receiver
      - '8889:8889' # Prometheus exporter metrics
    networks:
      - observability
    depends_on:
      - victoria-metrics
      - tempo
      - loki

  # VictoriaMetrics - Time series database for metrics
  victoria-metrics:
    image: victoriametrics/victoria-metrics:v1.99.0
    container_name: psy-victoria-metrics
    command:
      - '--storageDataPath=/victoria-metrics-data'
      - '--httpListenAddr=:8428'
      - '--retentionPeriod=30d'
    volumes:
      - victoria-metrics-data:/victoria-metrics-data
    ports:
      - '8428:8428'
    networks:
      - observability

  # Loki - Log aggregation
  loki:
    image: grafana/loki:2.9.4
    container_name: psy-loki
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml
      - loki-data:/loki
    ports:
      - '3100:3100'
    networks:
      - observability

  # Tempo - Distributed tracing
  tempo:
    image: grafana/tempo:2.3.1
    container_name: psy-tempo
    command: ['-config.file=/etc/tempo.yaml']
    volumes:
      - ./tempo-config.yaml:/etc/tempo.yaml
      - tempo-data:/tmp/tempo
    ports:
      - '3200:3200' # Tempo HTTP
      - '14268:14268' # Jaeger ingest
    networks:
      - observability

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:10.3.3
    container_name: psy-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
      - grafana-data:/var/lib/grafana
    ports:
      - '3001:3000'
    networks:
      - observability
    depends_on:
      - victoria-metrics
      - loki
      - tempo

  # Grafana Alloy - Faro RUM receiver + telemetry pipeline
  alloy:
    image: grafana/alloy:v1.0.0
    container_name: psy-alloy
    command:
      - run
      - --server.http.listen-addr=0.0.0.0:12345
      - /etc/alloy/config.alloy
    volumes:
      - ./alloy-config.alloy:/etc/alloy/config.alloy
    ports:
      - '12345:12345' # Alloy UI
      - '12347:12347' # Faro receiver
    networks:
      - observability
    depends_on:
      - loki
      - tempo

  # Prometheus - Scrapes metrics from services (fallback)
  prometheus:
    image: prom/prometheus:v2.49.1
    container_name: psy-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-remote-write-receiver'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - '9090:9090'
    networks:
      - observability

networks:
  observability:
    name: psy-observability

volumes:
  victoria-metrics-data:
  loki-data:
  tempo-data:
  grafana-data:
  prometheus-data:
